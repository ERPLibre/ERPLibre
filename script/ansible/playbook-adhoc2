#!/usr/bin/env python3

import argparse
import subprocess

# Configuration de l'analyseur d'arguments
parser = argparse.ArgumentParser(description="Ex√©cute un playbook Ansible sur des cibles sp√©cifi√©es en utilisant une cl√© SSH associ√©e √† un royaume.")
parser.add_argument("playbook", help="Nom du playbook Ansible √† ex√©cuter (sans l'extension .yml)")
parser.add_argument("--royaume", required=True, help="Identifiant du royaume pour s√©lectionner la cl√© SSH correspondante")
parser.add_argument("--cibles", nargs="+", required=True, help="Liste des adresses IP des cibles")

# Analyse des arguments
args = parser.parse_args()

# G√©n√©ration du nom du fichier d'inventaire
inventaire = f"./{args.playbook}.hosts"

# G√©n√©ration du contenu du fichier d'inventaire
contenu_inventaire = "[cibles]\n" + "\n".join(args.cibles)

# √âcriture du fichier d'inventaire
with open(inventaire, "w") as fichier:
    fichier.write(contenu_inventaire)

print(f"‚úÖ Fichier d'inventaire g√©n√©r√© : {inventaire}")

# Chemin de la cl√© priv√©e bas√©e sur le royaume
cle_ssh = f"~/.ssh/id_ed25519_{args.royaume}"

# Construction de la commande Ansible
commande = [
    "ansible-playbook",
    f"{args.playbook}.yml",
    "-i", inventaire,
    "--private-key", cle_ssh,
    "-K"  # Demande le mot de passe sudo si n√©cessaire
]

print(f"üöÄ Ex√©cution de : {' '.join(commande)}")

