#!/usr/bin/env python3

import os
import sys
import subprocess

# V√©rifier les arguments
if len(sys.argv) < 3:
    print("‚ùå Utilisation: ./playbook-adhoc <PLAYBOOK> <IP1> [<IP2> ...]")
    sys.exit(1)

PLAYBOOK = sys.argv[1]
TARGETS = sys.argv[2:]

# G√©n√©rer le nom du fichier d'inventaire
inventaireDuSysadmin = f"./{PLAYBOOK}.hosts"

# G√©n√©rer le contenu du fichier d'inventaire
choixDuSysadmin = "\n".join([f"{ip}" for ip in TARGETS])

inventory_content = f"""[leChoixDuSysadmin]
{choixDuSysadmin}
"""

# √âcrire l'inventaire dans un fichier temporaire
with open(inventaireDuSysadmin, "w") as file:
    file.write(inventory_content)

print(f"‚úÖ Fichier d'inventaire g√©n√©r√© : {inventaireDuSysadmin}")

# Ex√©cuter le playbook Ansible
command = f"ansible-playbook {PLAYBOOK}.yml -K -i {inventaireDuSysadmin} --private-key ~/.ssh/id_ed25519_ansible_Projet_KBR"
print(f"üöÄ Ex√©cution de : {command}")

try:
    subprocess.run(command, shell=True, check=True)
    print("‚úÖ Playbook ex√©cut√© avec succ√®s !")
except subprocess.CalledProcessError:
    print("‚ùå Erreur lors de l'ex√©cution du playbook.")

# Ne pas supprimer le fichier d'inventaire pour une r√©utilisation √©ventuelle
print(f"üìÇ Le fichier d'inventaire {inventaireDuSysadmin} est conserv√©.")

